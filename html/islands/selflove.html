<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Island of Self-Love</title>
  <link rel="stylesheet" href="../../css/style_island_selflove.css" />

</head>
<body>
    <div class="world">

    <!-- Titel (kann auch als Bild sein) -->
    <img src="../../images/insel1_schrift.png" alt="Island of Self-Love" class="title-text">

     <!-- Logo oben rechts -->
    <img src="../../images/lumora-logo.png" alt="Lumora" class="logo">

    </div>
    <div id="placementArea" class="placement-area"></div>
  <div class="screen">


    <!-- Linke Item-Box -->
    <div class="items-panel">
      <div class="items-header">Items:</div>
      <div class="item-row">
        <img src="../../images/item-house-selflove.png" draggable="true" data-item-id="1" alt="House" class="item-img">

        <span class="item-count">1</span>
        <img src="../../images/lightpoint-icon.png" alt="Sun Icon" class="item-sun">
      </div>

      <div class="item-row">
        <img src="../../images/item-tree-selflove.png" draggable="true" data-item-id="2" alt="Tree" class="item-img">
        <span class="item-count">1</span>
        <img src="../../images/lightpoint-icon.png" alt="Sun Icon" class="item-sun">
      </div>
    </div>

    <!-- Back -->
    <a href="../../php/world.php" class="btn-back">Back</a>

    <!-- Rechte Task-Box -->
    <div class="tasks-panel">
      <div class="tasks-header">Leftover Tasks: <span>3</span></div>
      <button class="btn-start" onclick="startTask()">Start task</button>
     </div>
     <script>
const ISLAND_ID = 1; // Selflove

const area = document.getElementById("placementArea");

// Dragstart von Items (die Bilder in deiner Box)
document.querySelectorAll(".item-img[draggable='true']").forEach(img => {
  img.addEventListener("dragstart", (e) => {
    const id = img.dataset.itemId;
    e.dataTransfer.setData("text/plain", id);
  });
});

// Drop erlauben
area.addEventListener("dragover", (e) => e.preventDefault());

// Drop => speichern
area.addEventListener("drop", async (e) => {
  e.preventDefault();

  const itemId = parseInt(e.dataTransfer.getData("text/plain"), 10);
  if (!itemId) return;

  const rect = area.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  let posX = x / rect.width;
  let posY = y / rect.height;

  // clamp 0..1
  posX = Math.max(0, Math.min(1, posX));
  posY = Math.max(0, Math.min(1, posY));

  const res = await fetch("/Lumora/php/place_item.php", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    credentials: "same-origin",
    body: JSON.stringify({ item_id: itemId, island_id: ISLAND_ID, pos_x: posX, pos_y: posY })
  });

  const data = await res.json();

  if (!res.ok) {
    if (data.error === "not_enough_lightpoints") {
      alert("Du hast keine Lightpoints mehr, um ein Item zu platzieren.");
    } else {
      alert(data.error || "Fehler beim Platzieren");
    }
    return;
  }

  // optional: Lightpoints UI updaten
  const lpEl = document.getElementById("lightpointsValue");
  if (lpEl) lpEl.textContent = data.total_lightpoints;

  await loadPlacedItems();
});

// Items laden und rendern
async function loadPlacedItems() {
  const res = await fetch(`/Lumora/php/get_placed_items.php?island_id=${ISLAND_ID}`, {
    credentials: "same-origin"
  });
  const data = await res.json();
  if (!res.ok) return;

  // alte entfernen
  area.querySelectorAll(".placed-item").forEach(n => n.remove());

  const rect = area.getBoundingClientRect();
  for (const it of data.items) {
    const el = document.createElement("img");
    el.className = "placed-item";
    el.src = it.asset_path;   // aus DB
    el.alt = it.name;

    el.style.left = (it.pos_x * rect.width) + "px";
    el.style.top  = (it.pos_y * rect.height) + "px";

    area.appendChild(el);
  }
}

document.addEventListener("DOMContentLoaded", loadPlacedItems);
</script>
