<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Island of Self-Love</title>
  <link rel="stylesheet" href="../../css/style_island_selflove.css" />

</head>
<body>
    <div class="world">

    <!-- Titel (kann auch als Bild sein) -->
    <img src="../../images/insel1_schrift.png" alt="Island of Self-Love" class="title-text">

     <!-- Logo oben rechts -->
    <img src="../../images/lumora-logo.png" alt="Lumora" class="logo">

    </div>
    <div id="placementArea" class="placement-area"></div>
  <div class="screen">

    <!-- Linke Item-Box -->
    <div class="items-panel">
      <div class="items-header">Items:</div>

      <div class="item-row">
        <img src="../../images/item-house-selflove.png" alt="House" class="item-img">
        <span class="item-count">1</span>
        <img src="../../images/lightpoint-icon.png" alt="Sun Icon" class="item-sun">
      </div>

      <div class="item-row">
        <img src="../../images/item-tree-selflove.png" alt="Tree" class="item-img">
        <span class="item-count">1</span>
        <img src="../../images/lightpoint-icon.png" alt="Sun Icon" class="item-sun">
      </div>
    </div>

    <!-- Back -->
    <a href="../../php/world.php" class="btn-back">Back</a>
    <!-- Help -->
    <div class="help-area">
      <img src="../../images/lichtgeist.png"
           alt="Help"
           class="help-icon">
      <div class="help-text">Need help?</div>
    </div>

    <!-- Rechte Task-Box -->
    <div class="tasks-panel">
      <div class="tasks-header">Leftover Tasks: <span>3</span></div>
      <button class="btn-start" onclick="startTask()">Start task</button>
     </div>
     <script>
async function startTask(category = "") {
  try {
    const url = category
      ? `/Lumora/php/start_task.php?category=${encodeURIComponent(category)}`
      : `/Lumora/php/start_task.php`;

    const res = await fetch(url, { credentials: "same-origin" });
    const data = await res.json();

    if (!res.ok) {
  if (data?.error === "limit_reached") {
    window.open("/Lumora/html/limit_reached.html", "_blank", "width=900,height=600");
    return;
  }
  alert(data.error || "Could not start task");
  return;
}


    localStorage.setItem("lumora_active_task", JSON.stringify(data));

    // WICHTIG: task_window.html muss genau hier liegen:
    // C:\xampp\htdocs\Lumora\html\task_window.html
    const w = window.open("/Lumora/html/task_window.html", "_blank", "width=900,height=600");

    if (!w) {
      alert("Popup wurde blockiert. Bitte Popups f√ºr localhost erlauben.");
    }
  } catch (e) {
    alert("JS Fehler: " + e.message);
  }
}
</script>
<script>
async function loadPlacedItems() {
  const res = await fetch("/Lumora/php/get_placed_items.php", { credentials: "same-origin" });
  const data = await res.json();
  if (!res.ok) return;

  const area = document.getElementById("placementArea");
  area.querySelectorAll(".placed-item").forEach(el => el.remove());

  for (const it of data.items) {
    const img = document.createElement("img");
    img.className = "placed-item";
    img.src = it.asset_path; // z.B. "/Lumora/assets/items/flower.png"
    img.alt = it.name;

    // relative 0..1 => pixel
    const x = it.pos_x * area.clientWidth;
    const y = it.pos_y * area.clientHeight;

    img.style.left = `${x}px`;
    img.style.top  = `${y}px`;

    area.appendChild(img);
  }
}

document.addEventListener("DOMContentLoaded", loadPlacedItems);
</script>
<script>
let selectedItemId = null;

function selectItem(itemId) {
  selectedItemId = itemId;
}

// Klick in den Rahmen = platzieren
document.addEventListener("DOMContentLoaded", () => {
  const area = document.getElementById("placementArea");

  area.addEventListener("click", async (e) => {
    if (!selectedItemId) return;

    const rect = area.getBoundingClientRect();
    const xPx = e.clientX - rect.left;
    const yPx = e.clientY - rect.top;

    // in relative Werte umrechnen (0..1)
    const posX = xPx / rect.width;
    const posY = yPx / rect.height;

    const res = await fetch("/Lumora/php/place_item.php", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "same-origin",
      body: JSON.stringify({
        item_id: selectedItemId,
        pos_x: posX,
        pos_y: posY
      })
    });

    const data = await res.json();

    if (!res.ok) {
      if (data.error === "not_enough_lightpoints") {
        alert("Du hast keine Lightpoints mehr, um ein Item zu platzieren.");
      } else {
        alert(data.error || "Fehler beim Platzieren");
      }
      return;
    }

    // UI aktualisieren
    const lpEl = document.getElementById("lightpointsValue");
    if (lpEl) lpEl.textContent = data.total_lightpoints;

    selectedItemId = null;
    await loadPlacedItems();
  });
});
</script>

</body>
</html>
