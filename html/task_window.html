<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Task</title>
  <style>
    body{margin:0;font-family:system-ui,Arial;background:#061427;color:#fff;height:100vh;display:flex;align-items:center;justify-content:center}
    .wrap{width:920px;max-width:92vw;min-height:520px;border-radius:18px;overflow:hidden;position:relative;
      background: radial-gradient(1200px 600px at 50% 10%, rgba(0,140,255,.25), transparent),
                  linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.10);
    }
    .top{padding:22px 26px;display:flex;justify-content:space-between;align-items:center}
    .badge{font-size:12px;letter-spacing:.6px;text-transform:uppercase;opacity:.85}
    .content{padding:14px 26px 26px;display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    .card{border-radius:16px;padding:18px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08)}
    h1{margin:0 0 10px;font-size:28px}
    p{margin:0;opacity:.88;line-height:1.45}
    .timerBox{display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center}
    .ring{width:180px;height:180px;border-radius:50%;display:grid;place-items:center;position:relative}
    .ring::before{content:"";position:absolute;inset:0;border-radius:50%;
      background:conic-gradient(rgba(0,140,255,.95) var(--p,0%), rgba(255,255,255,.10) 0);
      -webkit-mask:radial-gradient(circle, transparent 62%, #000 63%);
              mask:radial-gradient(circle, transparent 62%, #000 63%);
    }
    .time{font-size:34px;font-weight:700;letter-spacing:1px}
    .sub{font-size:13px;opacity:.8}
    .btns{display:flex;gap:12px;justify-content:flex-end;margin-top:14px}
    button{padding:10px 16px;border:0;border-radius:12px;cursor:pointer;font-weight:600}
    .btnGhost{background:rgba(255,255,255,.10);color:#fff}
    .btnPrimary{background:rgba(0,255,255,.25);color:#eaffff;border:1px solid rgba(0,255,255,.35)}
    .btnPrimary:disabled{opacity:.45;cursor:not-allowed}
    .designIcon{font-size:46px;opacity:.95}

    /* 4 ‚ÄúThemes‚Äù je Design */
    .theme-stopwatch{background:
      radial-gradient(800px 480px at 30% 20%, rgba(255,200,0,.18), transparent),
      radial-gradient(900px 520px at 70% 10%, rgba(0,255,255,.12), transparent),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
    .theme-motion{background:
      radial-gradient(900px 520px at 30% 20%, rgba(0,255,120,.16), transparent),
      radial-gradient(900px 520px at 80% 15%, rgba(0,255,255,.10), transparent),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
    .theme-breath{background:
      radial-gradient(900px 520px at 30% 15%, rgba(180,120,255,.18), transparent),
      radial-gradient(900px 520px at 75% 10%, rgba(0,255,255,.10), transparent),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
    .theme-calm{background:
      radial-gradient(900px 520px at 25% 10%, rgba(0,180,255,.18), transparent),
      radial-gradient(900px 520px at 80% 15%, rgba(0,255,255,.08), transparent),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}

    .hint{margin-top:10px;font-size:13px;opacity:.85}
    .steps{margin-top:10px;font-size:14px;opacity:.9}
    .steps li{margin:6px 0}
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="top">
      <div class="badge" id="badge">TASK</div>
      <div class="badge" id="remain"></div>
    </div>

    <div class="content">
      <div class="card">
        <h1 id="title">Task</h1>
        <p id="desc"></p>
        <div class="hint" id="hint"></div>
        <ul class="steps" id="steps" style="display:none;"></ul>

        <div class="btns">
          <button class="btnGhost" onclick="cancelTask()">Cancel</button>
          <button class="btnPrimary" id="doneBtn" onclick="doneTask()" disabled>Done</button>
        </div>
      </div>

      <div class="card timerBox">
        <div class="designIcon" id="icon">‚è±Ô∏è</div>
        <div class="ring" id="ring" style="--p:0%">
          <div style="text-align:center">
            <div class="time" id="time">00:00</div>
            <div class="sub" id="sub">Timer is running‚Ä¶</div>
          </div>
        </div>
      </div>

      
    </div>
  </div>

<script>
const task = JSON.parse(localStorage.getItem("lumora_active_task") || "null");

const wrap = document.getElementById("wrap");
const badge = document.getElementById("badge");
const remain = document.getElementById("remain");
const titleEl = document.getElementById("title");
const descEl = document.getElementById("desc");
const hintEl = document.getElementById("hint");
const stepsEl = document.getElementById("steps");
const iconEl = document.getElementById("icon");
const timeEl = document.getElementById("time");
const subEl = document.getElementById("sub");
const ring = document.getElementById("ring");
const doneBtn = document.getElementById("doneBtn");

let total = 0;
let left = 0;
let timer = null;

function mmss(s){
  const m = Math.floor(s/60);
  const r = s%60;
  return String(m).padStart(2,'0') + ":" + String(r).padStart(2,'0');
}

function applyDesign(variant){
  // default fallback
  wrap.classList.remove("theme-stopwatch","theme-motion","theme-breath","theme-calm");

  if (variant === "stopwatch") {
    wrap.classList.add("theme-stopwatch");
    iconEl.textContent = "‚è±Ô∏è";
    hintEl.textContent = "";
    
  } else if (variant === "motion") {
    wrap.classList.add("theme-motion");
    iconEl.textContent = "üåÄ";
    hintEl.textContent = "";
    stepsEl.style.display = "block";
    stepsEl.innerHTML = `
      <li>30s shoulder rolls backward</li>
      <li>30s shoulder rolls forward</li>
    `;
    
  } else if (variant === "breath") {
    wrap.classList.add("theme-breath");
    iconEl.textContent = "üå¨Ô∏è";
    hintEl.textContent = "";
    
  } else if (variant === "calm") {
    wrap.classList.add("theme-calm");
    iconEl.textContent = "ü´ß";
    hintEl.textContent = "";
    stepsEl.style.display = "block";
    stepsEl.innerHTML = `
      <li>Relax your forehead & jaw</li>
      <li>Let your shoulders drop</li>
      <li>Let your belly soften</li>
      <li>Notice your legs and feet</li>
    `;
    
  } else {
    wrap.classList.add("theme-stopwatch");
    iconEl.textContent = "‚ú®";
  }
}


function startTimer(seconds){
  total = seconds;
  left = seconds;
  timeEl.textContent = mmss(left);
  ring.style.setProperty("--p", "0%");
  doneBtn.disabled = true;

  timer = setInterval(() => {
    left--;
    if (left < 0) left = 0;
    timeEl.textContent = mmss(left);

    const p = Math.round(((total - left) / total) * 100);
    ring.style.setProperty("--p", p + "%");

    if (left === 0) {
      clearInterval(timer);
      timer = null;
      subEl.textContent = "Done! You can now klick on DONE.";
      doneBtn.disabled = false;
    }
  }, 1000);
}

function cancelTask() {
  window.close();
}

async function doneTask() {
  if (!task?.id) return;

  const res = await fetch("/Lumora/php/complete_task.php", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ quest_id: task.id })
  });

  const data = await res.json();
  if (!res.ok) {
  if (data?.error === "limit_reached") {
    window.location.href = "/Lumora/html/limit_reached.html";
    return;
  }
  alert(data.error || "Could not complete task");
  return;
}


  if (window.opener) window.opener.location.reload();
  window.close();
}

if (!task) {
  titleEl.textContent = "No Task found";
  descEl.textContent = "Please start the task again.";
  subEl.textContent = "";
} else {
  badge.textContent = (task.category || "TASK").toUpperCase();
  titleEl.textContent = task.title || "Task";
  descEl.textContent = task.description || "";
  if (typeof task.remaining_today !== "undefined") {
    remain.textContent = `Leftover Tasks: ${task.remaining_today}`;
  }

  applyDesign(task.design_variant || "default");
  startTimer(parseInt(task.duration_seconds || 60, 10));
}
</script>
</body>
</html>
